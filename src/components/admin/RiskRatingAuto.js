import React, { useState, useEffect } from "react";
import "../riskRating.css";

const RiskRatingAuto = () => {
  const [select, setSelect] = useState("");

  useEffect(() => {
    setSelect(document.querySelectorAll("select"));
  }, []);

  function adjustScore(elm) {
    elm.title = elm.target.value;
    globalUpdate();
    window.location.hash = getStatus();
  }

  var colors = ["#00D100", "#FFB52E", "#FF2E2E"];
  var scoreColors = ["#7dd", "#00D100", "#FFB52E", "#FF2E2E", "#c00"];
  function value2text(value) {
    return value < 3 ? "LOW" : value < 6 ? "MEDIUM" : "HIGH";
  }
  function val2score(value) {
    return value < 3 ? 0 : value < 6 ? 1 : 2;
  }
  function globalUpdate() {
    var likelihood = parseFloat(
      document.getElementById("likelihood").textContent
    );
    var techimpact = parseFloat(
      document.getElementById("techimpact").textContent
    );
    var busiimpact = parseFloat(
      document.getElementById("busiimpact").textContent
    );
    var adjust = parseFloat(document.getElementById("adjust").value);
    var impact = busiimpact * adjust + techimpact * (1 - adjust);
    function score2text(score) {
      return ["NOTE", "LOW", "MEDIUM", "HIGH", "CRITICAL"][score];
    }
    var score = val2score(likelihood) + val2score(impact);
    var elm = document.getElementById("risk");
    elm.textContent = score2text(score);
    elm.style.backgroundColor = scoreColors[score];
  }
  function getStatus() {
    var selects = document.querySelectorAll("select");
    var letters = "KMOZDXWLCIATFRSP";
    var vector = Array.prototype.map.call(selects, function (x, i) {
      return letters[i] + x.value;
    });
    vector = Array.prototype.reduce.call(vector, function (v, x, i) {
      return v + (i % 4 === 0 ? "/" : ":") + x;
    });
    // vector = vector,replace(/\//g)
    var percent = parseInt(
      100 * parseFloat(document.getElementById("adjust").value)
    );
    return "OWASP/" + vector + "/" + percent;
  }
  function clamp(num, min, max) {
    return Math.min(Math.max(num, min), max);
  }

  function setStatus(status) {
    status = (status.match(/\d+/g) || []).map(function (x) {
      return parseInt(x);
    });
    status = status.map(function (x, i) {
      return clamp(x, 0, i < 16 ? 9 : 100);
    });
    if (status.length !== 17)
      status = [1, 1, 0, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 3, 50];
    if (document.getElementById("adjust")?.value) {
      document.getElementById("adjust").value = status.pop() / 100.0;
    }

    Array.prototype?.map.call(select, function (elm, index) {
      elm.value = status[index];
      console.log(typeof elm);
      elm.onchange();
    });
  }

  var sections = ["likelihood", "techimpact", "busiimpact"];
  sections.map(function (name) {
    var updateFunc = function () {
      this.parentNode.style.backgroundColor = colors[val2score(this.value)];
      var selects = document.querySelectorAll("#tr_" + name + " select");
      var value =
        Math.round(
          (Array.prototype.reduce.call(
            selects,
            function (sum, elm) {
              return sum + parseInt(elm.value);
            },
            0
          ) *
            10) /
            selects.length
        ) / 10.0;
      var elm = document.getElementById(name);
      elm.textContent = value.toFixed(1);
      elm.style.backgroundColor = colors[val2score(value)];
      elm.nextSibling.style.backgroundColor = colors[val2score(value)];
      elm.nextSibling.textContent = value2text(value);
      globalUpdate();
      var status = getStatus();
      document.getElementById("vector").textContent = status;
      window.location.hash = status;
    };
    var selects = document.querySelectorAll("#tr_" + name + " select");
    Array.prototype.map.call(selects, function (elm) {
      elm.onchange = updateFunc;
    });
    return "";
  });

  setStatus(window.location.hash);
  window.onhashchange = function () {
    setStatus(window.location.hash);
  };
  window.onload = function () {
    var selects = document.querySelectorAll("select");
    Array.prototype.map.call(selects, function (x) {
      var td = x.parentNode;
      var tr = td.parentNode;
      var i = Array.prototype.indexOf.call(tr.children, td);
      var th = tr.previousElementSibling.children[i];
      th.title = x.title;
    });
  };
  if (document.getElementById("vector")?.onpaste) {
    document.getElementById("vector").onpaste = function (ev) {
      var vector = ev.clipboardData.getData("text");
      setStatus(vector);
      return ev.preventDefault();
    };
  }

  return (
    <>
      <h2 className="text-2xl text-black text-center mb-8">
        OWASP Risk Rating Calculator
      </h2>
      <div className="flex flex-col">
        <h3 className="text-xl text-center font-bold">Likelihoods</h3>
        <div className="mainrow" id="tr_likelihood">
          <div className="section">
            <h4 className="my-4 text-center">1. Threat Agent Factors</h4>
            <table>
              <tr>
                <th>Skill Level</th>
                <th>Motive</th>
                <th>Opportunity</th>
                <th>Size</th>
              </tr>
              <tr>
                <td>
                  <select title="How technically skilled would you consider the expected group of threat agents?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - No technical skills
                    </option>
                    <option value="2">2</option>
                    <option value="3">3 - Some technical skills</option>
                    <option value="4">4</option>
                    <option value="5">5 - Advanced computer user</option>
                    <option value="6">
                      6 - Network and programming skills
                    </option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9 - Security penetration skills</option>
                  </select>
                </td>
                <td>
                  <select title="How motivated is this group of threat agents to find and exploit this vulnerability?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Low or no reward
                    </option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - Possible reward</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9 - High reward</option>
                  </select>
                </td>
                <td>
                  <select title="What resources and opportunities are required for this group of threat agents to find and exploit this vulnerability?">
                    <option value="0" defaultValue>
                      0 - Full access or expensive resources required
                    </option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">
                      4 - Special access or resources required
                    </option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">
                      7 - Some access or resources required
                    </option>
                    <option value="8">8</option>
                    <option value="9">
                      9 - No access or resources required
                    </option>
                  </select>
                </td>
                <td>
                  <select title="How large is this group of threat agents?">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2" defaultValue>
                      2 - Developers, system administrators
                    </option>
                    <option value="3">3</option>
                    <option value="4">4 - Intranet users</option>
                    <option value="5">5 -Partners</option>
                    <option value="6">6 - Authenticated users</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9 - Anonymous Internet users</option>
                  </select>
                </td>
              </tr>
            </table>
          </div>
          <div className="section">
            <h4 className="text-center my-4">2. Vulnerability Factors</h4>
            <table>
              <tr>
                <th>Ease of Discovery</th>
                <th>Ease of Exploit</th>
                <th>Awareness</th>
                <th>Intrusion Detection</th>
              </tr>
              <tr>
                <td>
                  <select title="How easy is it for this group of threat agents to discover this vulnerability?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Practically impossible
                    </option>
                    <option value="2">2</option>
                    <option value="3">3 - Difficult</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - Easy</option>
                    <option value="8">8</option>
                    <option value="9">9 - Automated tools available</option>
                  </select>
                </td>
                <td>
                  <select title="How easy is it for this group of threat agents to actually exploit this vulnerability?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Theoretical
                    </option>
                    <option value="2">2</option>
                    <option value="3">3 - Difficult</option>
                    <option value="4">4</option>
                    <option value="5">5 - Easy</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9 - Automated tools available</option>
                  </select>
                </td>
                <td>
                  <select title="How well known is this vulnerability to this group of threat agents?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Unknown
                    </option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - Hidden</option>
                    <option value="5">5</option>
                    <option value="6">6 - Obvious</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9 - Public knowledge</option>
                  </select>
                </td>
                <td>
                  <select title="How likely is an exploit to be detected?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Active detection in application
                    </option>
                    <option value="2">2</option>
                    <option value="3">3 - Logged and reviewed</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8 - Logged without review</option>
                    <option value="9">9 - Not logged</option>
                  </select>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <div style={{ clear: "both" }}>&nbsp;</div>

        <h3 className="text-xl text-black font-bold text-center">Impact</h3>
        <div className="mainrow">
          <div className="section">
            <h4 className="text-center my-4">3. Technical Impact</h4>
            <table>
              <tr>
                <th>Loss of Confidentiality</th>
                <th>Loss of Integrity</th>
                <th>Loss of Availability</th>
                <th>Loss of Accountability</th>
              </tr>
              <tr id="tr_techimpact">
                <td>
                  <select title="How much data could be disclosed and how sensitive is it?">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2" defaultValue>
                      2 - Minimal non-sensitive data disclosed
                    </option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">
                      6 - Minimal critical data disclosed, extensive
                      non-sensitive data disclosed
                    </option>
                    <option value="7">
                      7 - Extensive critical data disclosed
                    </option>
                    <option value="8">8</option>
                    <option value="9">9 - All data disclosed</option>
                  </select>
                </td>
                <td>
                  <select title="How much data could be corrupted and how damaged is it?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Minimal slightly corrupt data
                    </option>
                    <option value="2">2</option>
                    <option value="3">
                      3 - Minimal seriously corrupt data
                    </option>
                    <option value="4">4</option>
                    <option value="5">
                      5 - Extensive slightly corrupt data
                    </option>
                    <option value="6">6</option>
                    <option value="7">
                      7- Extensive seriously corrupt data
                    </option>
                    <option value="8">8</option>
                    <option value="9">9 - All data totally corrupt</option>
                  </select>
                </td>
                <td>
                  <select title="How much service could be lost and how vital is it?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Minimal secondary services interrupted
                    </option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">
                      5 - Minimal primary services interrupted, extensive
                      secondary services interrupted
                    </option>
                    <option value="6">6</option>
                    <option value="7">
                      7 - Extensive primary services interrupted
                    </option>
                    <option value="8">8</option>
                    <option value="9">9 - All services completely lost</option>
                  </select>
                </td>
                <td>
                  <select title="Are the threat agents' actions traceable to an individual?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Fully traceable
                    </option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - Possibly traceable</option>
                    <option value="8">8</option>
                    <option value="9">9 - Completely anonymous</option>
                  </select>
                </td>
              </tr>
            </table>
          </div>
          <div className="section">
            <h4 className="my-4 text-center">4. Business Impact</h4>
            <table>
              <tr>
                <th>Financial Damage</th>
                <th>Reputation Damage</th>
                <th>Non-Compliance</th>
                <th>Privacy Violation</th>
              </tr>
              <tr id="tr_busiimpact">
                <td>
                  <select title="How much financial damage will result from an exploit?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Less than the cost to fix the vulnerability
                    </option>
                    <option value="2">2</option>
                    <option value="3">3 - Minor effect on annual profit</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">
                      7 - Significant effect on annual profit
                    </option>
                    <option value="8">8</option>
                    <option value="9">9 - Bankruptcy</option>
                  </select>
                </td>
                <td>
                  <select title="Would an exploit result in reputation damage that would harm the business?">
                    <option value="0">0</option>
                    <option value="1" defaultValue>
                      1 - Minimal damage
                    </option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - Loss of major accounts</option>
                    <option value="5">5 - Loss of goodwill</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9 - Brand damage</option>
                  </select>
                </td>
                <td>
                  <select title="How much exposure does non-compliance introduce?">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2" defaultValue>
                      2 - Minor violation
                    </option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 - Clear violation</option>
                    <option value="6">6</option>
                    <option value="7">7 - High profile violation</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                  </select>
                </td>
                <td>
                  <select title="How much personally identifiable information could be disclosed?">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" defaultValue>
                      3 - One individual
                    </option>
                    <option value="4">4</option>
                    <option value="5">5 - Hundreds of people</option>
                    <option value="6">6</option>
                    <option value="7">7 - Thousands of people</option>
                    <option value="8">8</option>
                    <option value="9">9 - Millions of people</option>
                  </select>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <div style={{ clear: "both" }}>&nbsp;</div>
        <h3 className="text-xl text-black font-bold text-center">Scores</h3>
        <div className="mainrow">
          <div className="section">
            <h4 className="my-4 text-center">5. Intermediate</h4>
            <table id="scores">
              <tr>
                <th colspan="2">Overall Likelihood</th>
                <th colspan="2">Overall Technical Impact</th>
                <th colspan="2">Overall Business Impact</th>
              </tr>
              <tr>
                <td id="likelihood">1</td>
                <td>LOW</td>
                <td id="techimpact">1.25</td>
                <td>LOW</td>
                <td id="busiimpact">1.75</td>
                <td>LOW</td>
              </tr>
            </table>
          </div>
          <div className="section">
            <h4 className="text-center my-4">6. Final Score</h4>
            <table id="finalscore">
              <tr>
                <th>Adjust score</th>
                <th>Risk</th>
              </tr>
              <tr>
                <td>
                  Technical &nbsp;&nbsp;
                  <input
                    id="adjust"
                    type="range"
                    min="0"
                    max="1"
                    value="0.5"
                    title="0.5"
                    step="0.05"
                    onChange={(e) => adjustScore(e)}
                  />
                  &nbsp;&nbsp; Business
                </td>
                <td id="risk">NOTE</td>
              </tr>
            </table>
          </div>
        </div>

        <div style={{ clear: "both" }}>&nbsp;</div>
        <div id="footer">
          <img style={{ float: "left" }} height="30" alt="" />
          <div className="flex items-center justify-center w-full my-8">
            <h1 className="text-2xl">Vector:</h1>
            <pre
              style={{ float: "left", background: "white", fontSize: "20px" }}
              id="vector"
              title="K sKill Level&#x0a;M Motive&#x0a;O Opportunity&#x0a;Z siZe&#x0a;D ease of Discovery&#x0a;X ease of eXploit&#x0a;W aWareness&#x0a;L intrusion detection (Logging)&#x0a;C loss of Confidentiality&#x0a;I loss of Integrity&#x0a;A loss of Availability&#x0a;T loss of accountability (Trackability)&#x0a;F Financial damage&#x0a;R Reputation damage&#x0a;S non-compliance (Standards)&#x0a;P Privacy violation&#x0a;"
            ></pre>
          </div>
        </div>
      </div>
    </>
  );
};

export default RiskRatingAuto;
